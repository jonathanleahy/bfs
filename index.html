<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>London Underground Journey Planner</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #controls {
            margin-bottom: 20px;
        }
        #network-svg {
            border: 1px solid #ccc;
        }
        .node {
            cursor: pointer;
        }
        .link {
            stroke-opacity: 0.6;
        }
        .station-label {
            font-size: 8px;
            pointer-events: none;
        }
        #journey-info {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
        }
        #error-message {
            color: red;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>London Underground Journey Planner</h1>
    <div id="controls">
        <label for="num-stops">Number of Stops:</label>
        <input type="number" id="num-stops" min="1" max="20" value="5">
        <button id="zoom-in">Zoom In</button>
        <button id="zoom-out">Zoom Out</button>
    </div>
    <svg id="network-svg" width="1200" height="800"></svg>
    <div id="journey-info"></div>
    <div id="error-message"></div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Set up the SVG
        const svg = d3.select("#network-svg");
        const width = +svg.attr("width");
        const height = +svg.attr("height");
        const g = svg.append("g");

        // Define the London Underground network
        const undergroundNetwork = {
            Bakerloo: {
                'Elephant & Castle': ['Lambeth North'],
                'Lambeth North': ['Elephant & Castle', 'Waterloo'],
                'Waterloo': ['Lambeth North', 'Embankment'],
                'Embankment': ['Waterloo', 'Charing Cross'],
                'Charing Cross': ['Embankment', 'Piccadilly Circus'],
                'Piccadilly Circus': ['Charing Cross', 'Oxford Circus'],
                'Oxford Circus': ['Piccadilly Circus', 'Regent\'s Park'],
                'Regent\'s Park': ['Oxford Circus', 'Baker Street'],
                'Baker Street': ['Regent\'s Park', 'Marylebone'],
                'Marylebone': ['Baker Street', 'Edgware Road'],
                'Edgware Road': ['Marylebone', 'Paddington'],
                'Paddington': ['Edgware Road', 'Warwick Avenue']
            },
            Central: {
                'Notting Hill Gate': ['Queensway', 'Holland Park'],
                'Queensway': ['Notting Hill Gate', 'Lancaster Gate'],
                'Lancaster Gate': ['Queensway', 'Marble Arch'],
                'Marble Arch': ['Lancaster Gate', 'Bond Street'],
                'Bond Street': ['Marble Arch', 'Oxford Circus'],
                'Oxford Circus': ['Bond Street', 'Tottenham Court Road'],
                'Tottenham Court Road': ['Oxford Circus', 'Holborn'],
                'Holborn': ['Tottenham Court Road', 'Chancery Lane'],
                'Chancery Lane': ['Holborn', 'St. Paul\'s'],
                'St. Paul\'s': ['Chancery Lane', 'Bank']
            },
            Circle: {
                'Paddington': ['Edgware Road', 'Bayswater'],
                'Bayswater': ['Paddington', 'Notting Hill Gate'],
                'Notting Hill Gate': ['Bayswater', 'High Street Kensington'],
                'High Street Kensington': ['Notting Hill Gate', 'Gloucester Road'],
                'Gloucester Road': ['High Street Kensington', 'South Kensington'],
                'South Kensington': ['Gloucester Road', 'Sloane Square'],
                'Sloane Square': ['South Kensington', 'Victoria'],
                'Victoria': ['Sloane Square', 'St. James\'s Park'],
                'St. James\'s Park': ['Victoria', 'Westminster'],
                'Westminster': ['St. James\'s Park', 'Embankment'],
                'Embankment': ['Westminster', 'Temple'],
                'Temple': ['Embankment', 'Blackfriars'],
                'Blackfriars': ['Temple', 'Mansion House'],
                'Mansion House': ['Blackfriars', 'Cannon Street'],
                'Cannon Street': ['Mansion House', 'Monument'],
                'Monument': ['Cannon Street', 'Tower Hill'],
                'Tower Hill': ['Monument', 'Aldgate'],
                'Aldgate': ['Tower Hill', 'Liverpool Street'],
                'Liverpool Street': ['Aldgate', 'Moorgate'],
                'Moorgate': ['Liverpool Street', 'Barbican'],
                'Barbican': ['Moorgate', 'Farringdon'],
                'Farringdon': ['Barbican', 'King\'s Cross St. Pancras'],
                'King\'s Cross St. Pancras': ['Farringdon', 'Euston Square'],
                'Euston Square': ['King\'s Cross St. Pancras', 'Great Portland Street'],
                'Great Portland Street': ['Euston Square', 'Baker Street'],
                'Baker Street': ['Great Portland Street', 'Edgware Road'],
                'Edgware Road': ['Baker Street', 'Paddington']
            },
            District: {
                'Edgware Road': ['Paddington'],
                'Paddington': ['Edgware Road', 'Bayswater'],
                'Bayswater': ['Paddington', 'Notting Hill Gate'],
                'Notting Hill Gate': ['Bayswater', 'High Street Kensington'],
                'High Street Kensington': ['Notting Hill Gate', 'Earl\'s Court'],
                'Earl\'s Court': ['High Street Kensington', 'Gloucester Road'],
                'Gloucester Road': ['Earl\'s Court', 'South Kensington'],
                'South Kensington': ['Gloucester Road', 'Sloane Square'],
                'Sloane Square': ['South Kensington', 'Victoria'],
                'Victoria': ['Sloane Square', 'St. James\'s Park'],
                'St. James\'s Park': ['Victoria', 'Westminster'],
                'Westminster': ['St. James\'s Park', 'Embankment'],
                'Embankment': ['Westminster', 'Temple'],
                'Temple': ['Embankment', 'Blackfriars'],
                'Blackfriars': ['Temple', 'Mansion House'],
                'Mansion House': ['Blackfriars', 'Cannon Street'],
                'Cannon Street': ['Mansion House', 'Monument'],
                'Monument': ['Cannon Street', 'Tower Hill'],
                'Tower Hill': ['Monument', 'Aldgate East']
            },
            Jubilee: {
                'Baker Street': ['Bond Street'],
                'Bond Street': ['Baker Street', 'Green Park'],
                'Green Park': ['Bond Street', 'Westminster'],
                'Westminster': ['Green Park', 'Waterloo'],
                'Waterloo': ['Westminster', 'Southwark'],
                'Southwark': ['Waterloo', 'London Bridge'],
                'London Bridge': ['Southwark', 'Bermondsey']
            },
            Metropolitan: {
                'Aldgate': ['Liverpool Street'],
                'Liverpool Street': ['Aldgate', 'Moorgate'],
                'Moorgate': ['Liverpool Street', 'Barbican'],
                'Barbican': ['Moorgate', 'Farringdon'],
                'Farringdon': ['Barbican', 'King\'s Cross St. Pancras'],
                'King\'s Cross St. Pancras': ['Farringdon', 'Euston Square'],
                'Euston Square': ['King\'s Cross St. Pancras', 'Great Portland Street'],
                'Great Portland Street': ['Euston Square', 'Baker Street'],
                'Baker Street': ['Great Portland Street', 'Finchley Road']
            },
            Northern: {
                'Battersea Power Station': ['Nine Elms'],
                'Nine Elms': ['Battersea Power Station', 'Kennington'],
                'Kennington': ['Nine Elms', 'Waterloo'],
                'Waterloo': ['Kennington', 'Embankment'],
                'Embankment': ['Waterloo', 'Charing Cross'],
                'Charing Cross': ['Embankment', 'Leicester Square'],
                'Leicester Square': ['Charing Cross', 'Tottenham Court Road'],
                'Tottenham Court Road': ['Leicester Square', 'Goodge Street'],
                'Goodge Street': ['Tottenham Court Road', 'Warren Street'],
                'Warren Street': ['Goodge Street', 'Euston'],
                'Euston': ['Warren Street', 'King\'s Cross St. Pancras'],
                'King\'s Cross St. Pancras': ['Euston', 'Angel'],
                'Angel': ['King\'s Cross St. Pancras', 'Old Street'],
                'Old Street': ['Angel', 'Moorgate']
            },
            Piccadilly: {   
                'Earl\'s Court': ['Gloucester Road'],
                'Gloucester Road': ['Earl\'s Court', 'South Kensington'],
                'South Kensington': ['Gloucester Road', 'Knightsbridge'],
                'Knightsbridge': ['South Kensington', 'Hyde Park Corner'],
                'Hyde Park Corner': ['Knightsbridge', 'Green Park'],
                'Green Park': ['Hyde Park Corner', 'Piccadilly Circus'],
                'Piccadilly Circus': ['Green Park', 'Leicester Square'],
                'Leicester Square': ['Piccadilly Circus', 'Covent Garden'],
                'Covent Garden': ['Leicester Square', 'Holborn'],
                'Holborn': ['Covent Garden', 'Russell Square'],
                'Russell Square': ['Holborn', 'King\'s Cross St. Pancras']
            },
            Victoria: {
                'Brixton': ['Stockwell'],
                'Stockwell': ['Brixton', 'Vauxhall'],
                'Vauxhall': ['Stockwell', 'Pimlico'],
                'Pimlico': ['Vauxhall', 'Victoria'],
                'Victoria': ['Pimlico', 'Green Park'],
                'Green Park': ['Victoria', 'Oxford Circus'],
                'Oxford Circus': ['Green Park', 'Warren Street'],
                'Warren Street': ['Oxford Circus', 'Euston'],
                'Euston': ['Warren Street', 'King\'s Cross St. Pancras'],
                'King\'s Cross St. Pancras': ['Euston', 'Highbury & Islington'],
                'Highbury & Islington': ['King\'s Cross St. Pancras', 'Finsbury Park']
            }
        };

        const lineColors = {
            Bakerloo: "#B36305",
            Central: "#E32017",
            Circle: "#FFD300",
            District: "#00782A",
            Jubilee: "#A0A5A9",
            Metropolitan: "#9B0056",
            Northern: "#000000",
            Piccadilly: "#003688",
            Victoria: "#0098D4"
        };

        // Prepare data for D3
        const nodes = [];
        const links = [];
        const combinedNetwork = {};

        Object.entries(undergroundNetwork).forEach(([line, stations]) => {
            Object.entries(stations).forEach(([station, neighbors]) => {
                if (!nodes.some(n => n.id === station)) {
                    nodes.push({ id: station, line: line });
                }
                if (!combinedNetwork[station]) {
                    combinedNetwork[station] = new Set();
                }
                neighbors.forEach(neighbor => {
                    if (!nodes.some(n => n.id === neighbor)) {
                        nodes.push({ id: neighbor, line: line });
                    }
                    links.push({ source: station, target: neighbor, line: line });
                    combinedNetwork[station].add(neighbor);
                    if (!combinedNetwork[neighbor]) {
                        combinedNetwork[neighbor] = new Set();
                    }
                    combinedNetwork[neighbor].add(station);
                });
            });
        });

        const stationPositions = {
            "Baker Street": { x: 400, y: 300 },
            "Oxford Circus": { x: 450, y: 350 },
            "Piccadilly Circus": { x: 450, y: 400 },
            "Green Park": { x: 400, y: 400 },
            "Westminster": { x: 500, y: 450 },
            "Waterloo": { x: 550, y: 500 },
            "Elephant & Castle": { x: 600, y: 600 },
            "Lambeth North": { x: 575, y: 550 },
            "Embankment": { x: 500, y: 475 },
            "Charing Cross": { x: 475, y: 425 },
            "Regent's Park": { x: 425, y: 275 },
            "Marylebone": { x: 375, y: 275 },
            "Edgware Road": { x: 350, y: 250 },
            "Paddington": { x: 300, y: 250 },
            "Warwick Avenue": { x: 250, y: 225 },
            "Notting Hill Gate": { x: 250, y: 350 },
            "Holland Park": { x: 225, y: 325 },  // Add Holland Park
            "Queensway": { x: 275, y: 325 },
            "Lancaster Gate": { x: 300, y: 300 },
            "Marble Arch": { x: 350, y: 350 },
            "Bond Street": { x: 400, y: 350 },
            "Tottenham Court Road": { x: 500, y: 350 },
            "Holborn": { x: 550, y: 350 },
            "Chancery Lane": { x: 600, y: 350 },
            "St. Paul's": { x: 650, y: 350 },
            "Bank": { x: 700, y: 350 },
            "Bayswater": { x: 275, y: 300 },
            "High Street Kensington": { x: 250, y: 400 },
            "Gloucester Road": { x: 300, y: 450 },
            "South Kensington": { x: 350, y: 450 },
            "Sloane Square": { x: 400, y: 500 },
            "Victoria": { x: 450, y: 500 },
            "St. James's Park": { x: 475, y: 475 },
            "Temple": { x: 550, y: 450 },
            "Blackfriars": { x: 600, y: 425 },
            "Mansion House": { x: 650, y: 400 },
            "Cannon Street": { x: 675, y: 375 },
            "Monument": { x: 700, y: 375 },
            "Tower Hill": { x: 750, y: 375 },
            "Aldgate": { x: 775, y: 350 },
            "Liverpool Street": { x: 750, y: 300 },
            "Moorgate": { x: 700, y: 275 },
            "Barbican": { x: 650, y: 250 },
            "Farringdon": { x: 600, y: 225 },
            "King's Cross St. Pancras": { x: 550, y: 200 },
            "Euston Square": { x: 500, y: 225 },
            "Great Portland Street": { x: 450, y: 250 },
            "Earl's Court": { x: 250, y: 500 },
            "Aldgate East": { x: 800, y: 375 },
            "Southwark": { x: 600, y: 525 },
            "London Bridge": { x: 650, y: 500 },
            "Bermondsey": { x: 700, y: 475 },
            "Finchley Road": { x: 300, y: 200 },
            "Battersea Power Station": { x: 400, y: 600 },
            "Nine Elms": { x: 450, y: 575 },
            "Kennington": { x: 500, y: 550 },
            "Leicester Square": { x: 475, y: 375 },
            "Goodge Street": { x: 500, y: 325 },
            "Warren Street": { x: 500, y: 275 },
            "Euston": { x: 525, y: 250 },
            "Angel": { x: 600, y: 175 },
            "Knightsbridge": { x: 350, y: 425 },
            "Hyde Park Corner": { x: 375, y: 425 },
            "Covent Garden": { x: 525, y: 375 },
            "Russell Square": { x: 575, y: 300 },
            "Brixton": { x: 500, y: 650 },
            "Stockwell": { x: 500, y: 600 },
            "Vauxhall": { x: 475, y: 550 },
            "Pimlico": { x: 475, y: 525 },
            "Highbury & Islington": { x: 600, y: 150 },
            "Finsbury Park": { x: 625, y: 125 },
            "Old Street": { x: 675, y: 275 }  // Add this line
        };

        // Modify the nodes array to include these fixed positions
        nodes.forEach(node => {
            if (stationPositions[node.id]) {
                node.fx = stationPositions[node.id].x;
                node.fy = stationPositions[node.id].y;
            } else {
                // For nodes without defined positions, set initial position but allow movement
                node.x = width / 2 + (Math.random() - 0.5) * 100;
                node.y = height / 2 + (Math.random() - 0.5) * 100;
            }
        });

        // Add this after the nodes forEach loop
        nodes.forEach(node => {
            if (!stationPositions[node.id]) {
                console.warn(`Missing position for station: ${node.id}`);
            }
        });

        // Add zoom functionality
        const zoom = d3.zoom()
            .scaleExtent([0.5, 4])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Function to calculate the bounding box of all stations
        function calculateBoundingBox(stations) {
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            Object.values(stations).forEach(station => {
                minX = Math.min(minX, station.x);
                minY = Math.min(minY, station.y);
                maxX = Math.max(maxX, station.x);
                maxY = Math.max(maxY, station.y);
            });
            return { minX, minY, maxX, maxY };
        }

        // Calculate the bounding box
        const bbox = calculateBoundingBox(stationPositions);

        // Calculate the scale to fit the network in the SVG
        const scale = Math.min(
            width / (bbox.maxX - bbox.minX),
            height / (bbox.maxY - bbox.minY)
        ) * 0.9; // 0.9 to add some padding

        // Calculate the transform to center the network
        const translateX = (width - scale * (bbox.maxX + bbox.minX)) / 2;
        const translateY = (height - scale * (bbox.maxY + bbox.minY)) / 2;

        // Set initial zoom level
        const initialTransform = d3.zoomIdentity
            .translate(translateX, translateY)
            .scale(scale);

        svg.call(zoom.transform, initialTransform);

        // Function to handle zooming
        function handleZoom(direction) {
            const currentTransform = d3.zoomTransform(svg.node());
            const scale = direction === 'in' ? currentTransform.k * 1.2 : currentTransform.k / 1.2;
            const newTransform = d3.zoomIdentity
                .translate(currentTransform.x, currentTransform.y)
                .scale(scale);
            svg.transition().duration(300).call(zoom.transform, newTransform);
        }

        // Add event listeners for zoom buttons
        document.getElementById('zoom-in').addEventListener('click', () => handleZoom('in'));
        document.getElementById('zoom-out').addEventListener('click', () => handleZoom('out'));

        // Create a force simulation
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(30))
            .force("charge", d3.forceManyBody().strength(-50))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(10));

        // Create the links
        const link = g.append("g")
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("class", "link")
            .attr("stroke", d => lineColors[d.line]);

        // Create the nodes
        const node = g.append("g")
            .selectAll("circle")
            .data(nodes)
            .join("circle")
            .attr("class", "node")
            .attr("r", 4)
            .attr("fill", "white")
            .attr("stroke", d => lineColors[d.line])
            .attr("stroke-width", 2);

        // Add station labels
        const label = g.append("g")
            .selectAll("text")
            .data(nodes)
            .join("text")
            .attr("class", "station-label")
            .text(d => d.id)
            .attr("text-anchor", "middle")
            .attr("dy", -6);

        // Update positions on each tick of the simulation
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);

            label
                .attr("x", d => d.x)
                .attr("y", d => d.y);
        });

        // Drag functionality
        function drag(simulation) {
            function dragstarted(event) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                event.subject.fx = event.subject.x;
                event.subject.fy = event.subject.y;
            }

            function dragged(event) {
                event.subject.fx = event.x;
                event.subject.fy = event.y;
            }

            function dragended(event) {
                if (!event.active) simulation.alphaTarget(0);
                event.subject.fx = null;
                event.subject.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }

        let selectedStation = null;

        // Updated BFS function
        function bfs(start, maxStops) {
            const queue = [[start]];
            const visited = new Set([start]);
            const reachableStations = [];

            while (queue.length > 0) {
                const path = queue.shift();
                const station = path[path.length - 1];

                if (path.length > 1 && path.length <= maxStops + 1) {
                    reachableStations.push(path);
                }

                if (path.length <= maxStops) {
                    const neighbors = new Set();
                    for (const line in undergroundNetwork) {
                        if (undergroundNetwork[line][station]) {
                            undergroundNetwork[line][station].forEach(neighbor => neighbors.add(neighbor));
                        }
                    }
                    for (const neighbor of neighbors) {
                        if (!visited.has(neighbor)) {
                            visited.add(neighbor);
                            queue.push([...path, neighbor]);
                        }
                    }
                }
            }

            return reachableStations;
        }

        // Plan journey function
        function planJourney() {
            if (!selectedStation) {
                document.getElementById("journey-info").innerHTML = "Please select a starting station by clicking on a node.";
                return;
            }

            const numStops = parseInt(document.getElementById("num-stops").value);
            const reachableStations = bfs(selectedStation, numStops);

            // Reset previous highlighting and set all lines to be slightly transparent
            link.attr("stroke", d => lineColors[d.line])
                .attr("stroke-width", 1)
                .attr("stroke-opacity", 0.8);  // Increased opacity for unselected lines
            node.attr("stroke", d => lineColors[d.line])
                .attr("stroke-width", 2)
                .attr("fill-opacity", 0.8)
                .attr("stroke-opacity", 0.8);

            // Highlight the selected station
            node.filter(n => n.id === selectedStation)
                .attr("stroke", "black")
                .attr("stroke-width", 3)
                .attr("fill-opacity", 1)
                .attr("stroke-opacity", 1);

            // Highlight the journey
            reachableStations.forEach(path => {
                for (let i = 0; i < path.length - 1; i++) {
                    const source = path[i];
                    const target = path[i + 1];
                    link.filter(l => (l.source.id === source && l.target.id === target) || 
                                     (l.source.id === target && l.target.id === source))
                        .attr("stroke-width", 3)
                        .attr("stroke-opacity", 1);  // Full opacity for selected routes
                }
                node.filter(n => path.includes(n.id))
                    .attr("stroke-width", 3)
                    .attr("fill-opacity", 1)
                    .attr("stroke-opacity", 1);
            });

            // Display journey information
            const journeyInfo = document.getElementById("journey-info");
            journeyInfo.innerHTML = `<h3>Possible Journeys from ${selectedStation} (up to ${numStops} stops):</h3>`;
            reachableStations.forEach(path => {
                journeyInfo.innerHTML += `<p>${path.join(" → ")}</p>`;
            });
        }

        // Node selection and auto-calculate
        node.on("click", (event, d) => {
            selectedStation = d.id;
            planJourney();
        });

        // Auto-calculate when number of stops changes
        document.getElementById("num-stops").addEventListener("change", planJourney);

        // Initial instructions
        document.getElementById("journey-info").innerHTML = "Click on a station to start planning your journey.";

        d3.json("src/data/nodes.json").then(function(graph) {
            // Ensure "graph" contains the nodes and links
            console.log(graph);

            // ... rest of your code
        });

        function initializeSimulation(graph) {
            var simulation = d3.forceSimulation(graph.nodes)
                .force("link", d3.forceLink(graph.links).id(function(d) { return d.id; }))
                .force("charge", d3.forceManyBody())
                .force("center", d3.forceCenter(width / 2, height / 2));

            // ... rest of your simulation code
        }

        function highlightNode(nodeId) {
            var node = d3.selectAll(".node")
                .filter(d => d.id === nodeId);

            if (node.empty()) {
                console.error("Node not found: " + nodeId);
                return;
            }

            node.attr("fill", "red")
                .attr("r", 6);
        }

        // Example usage (move this to after the simulation has started)
        setTimeout(() => {
            highlightNode("Warwick Avenue");
        }, 1000);

        function getNodeById(nodeId) {
            var node = graph.nodes.find(function(n) { return n.id === nodeId; });

            if (!node) {
                throw new Error("Node not found: " + nodeId);
            }

            return node;
        }

        try {
            // Your code that might throw an error
        } catch (error) {
            console.error(error);
        }

    });
    </script>
    <!-- D3.js library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Remove or comment out these lines -->
    <!--
    <script src="src/js/forceSimulation.js"></script>
    <script src="src/js/interaction.js"></script>
    <script src="src/js/main.js"></script>
    -->
</body>
</html>